[tox]
envlist = py{311,312},ruff-format,ruff-lint,mypy,bandit
isolated_build = true
skip_missing_interpreters = true
minversion = 4.0

[testenv]
description = Run tests with pytest and coverage
package = editable
deps =
    pytest>=8.3.4
    pytest-cov>=6.0.0
    pytest-asyncio>=0.24.0
    coverage[toml]>=7.6.0
commands =
    pytest {posargs:tests} \
        --cov=app \
        --cov-report=term-missing \
        --cov-report=html \
        --cov-report=xml \
        --cov-fail-under=65

[testenv:ruff-format]
description = Check code formatting with ruff
skip_install = true
deps = ruff>=0.8.0
commands = ruff format --check --diff .

[testenv:ruff-lint]
description = Run linting checks with ruff
skip_install = true
deps = ruff>=0.8.0
commands = ruff check .

[testenv:mypy]
description = Run type checking with mypy
deps =
    mypy>=1.13.0
    types-requests
    sqlalchemy[mypy]
commands = mypy app scripts tests

[testenv:bandit]
description = Run security checks with bandit
skip_install = true
deps = bandit>=1.8.0
commands = bandit -r app scripts -ll -x tests

[testenv:coverage]
description = Generate coverage report
deps =
    pytest>=8.3.4
    pytest-cov>=6.0.0
    pytest-asyncio>=0.24.0
    coverage[toml]>=7.6.0
commands =
    pytest tests --cov=app --cov-report=html --cov-report=term
    coverage report

[testenv:lint]
description = Run all linting checks (meta-environment for local development)
skip_install = true
deps =
    ruff>=0.8.0
    mypy>=1.13.0
    bandit>=1.8.0
    types-requests
    sqlalchemy[mypy]
commands =
    ruff format --check .
    ruff check .
    mypy app scripts tests
    bandit -r app scripts -ll

[testenv:format]
description = Auto-format code with ruff
skip_install = true
deps = ruff>=0.8.0
commands =
    ruff format .
    ruff check --fix .

