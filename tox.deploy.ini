[tox]
requires = tox>=4.11
env_list =
    package-build
    alembic-smoke
    scripts-syntax

[testenv]
skip_install = true
pass_env =
    PYTHONPATH
allowlist_externals =
    python
    npm
    alembic
    bash

[testenv:package-build]
description = Ensure backend and frontend build artefacts succeed
deps =
    build>=1,<2
commands =
    python -m pip install --upgrade pip
    python -m build backend
    npm ci --prefix frontend
    npm run build --prefix frontend

[testenv:alembic-smoke]
description = Validate migrations apply on SQLite
deps =
    build>=1,<2
commands_pre =
    python -m pip install --upgrade pip
    python -m pip install -e backend
    python -c "from pathlib import Path; Path('{toxinidir}/backend/.alembic-smoke.db').unlink(missing_ok=True)"
setenv =
    DATABASE_URL = sqlite+aiosqlite:///{toxinidir}/backend/.alembic-smoke.db
commands =
    bash -c "cd backend && alembic upgrade head"

[testenv:scripts-syntax]
description = Shell syntax check for deployment helpers
commands =
    bash -n scripts/deploy_build.sh
    bash -n scripts/pi_deploy.sh
    bash -n scripts/dev_backend.sh
    bash -n scripts/dev_frontend.sh

