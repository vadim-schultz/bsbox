[tox]
requires = tox>=4.11
env_list =
    backend-lint
    backend-format
    backend-type
    backend-test
    backend-integration
    backend-build
    frontend-typecheck
    frontend-test
    frontend-build
    deploy-package
    deploy-migrations
    deploy-scripts

[testenv]
skip_install = true
pass_env =
    DATABASE_URL
    PYTHONPATH
    PYTHONIOENCODING
deps =
    tox>=4.11
commands =
    python -c "print('Select an env, e.g. tox -e backend-test or frontend-build')"
allowlist_externals =
    python

[testenv:backend-lint]
description = Run backend linting suite
commands =
    python -m tox -c {toxinidir}/tox.backend.ini -e py311-lint {posargs}

[testenv:backend-format]
description = Run backend formatter check
commands =
    python -m tox -c {toxinidir}/tox.backend.ini -e py311-format {posargs}

[testenv:backend-type]
description = Run backend type checking
commands =
    python -m tox -c {toxinidir}/tox.backend.ini -e py311-type {posargs}

[testenv:backend-test]
description = Run backend unit tests
commands =
    python -m tox -c {toxinidir}/tox.backend.ini -e py311-test {posargs}

[testenv:backend-integration]
description = Run backend integration smoke tests
commands =
    python -m tox -c {toxinidir}/tox.backend.ini -e py311-integration {posargs}

[testenv:backend-build]
description = Build backend packages
commands =
    python -m tox -c {toxinidir}/tox.backend.ini -e py311-build {posargs}

[testenv:frontend-typecheck]
description = Run frontend type checker
commands =
    python -m tox -c {toxinidir}/tox.frontend.ini -e npm-typecheck {posargs}

[testenv:frontend-test]
description = Run frontend unit tests
commands =
    python -m tox -c {toxinidir}/tox.frontend.ini -e npm-test {posargs}

[testenv:frontend-build]
description = Build frontend assets
commands =
    python -m tox -c {toxinidir}/tox.frontend.ini -e npm-build {posargs}

[testenv:deploy-package]
description = Build backend/frontend artefacts
commands =
    python -m tox -c {toxinidir}/tox.deploy.ini -e package-build {posargs}

[testenv:deploy-migrations]
description = Smoke-test alembic migrations
commands =
    python -m tox -c {toxinidir}/tox.deploy.ini -e alembic-smoke {posargs}

[testenv:deploy-scripts]
description = Validate deployment script syntax
commands =
    python -m tox -c {toxinidir}/tox.deploy.ini -e scripts-syntax {posargs}

