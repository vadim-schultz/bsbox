[tox]
requires =
    tox>=4.15
    tox-poetry-installer>=0.10.3
env_list =
    py311-lint
    py311-type
    py311-test
    py311-format
    py311-build
    node20-lint
    node20-type
    node20-test
    node20-build
    security
    py311-all
    node20-all
    ci

[gh-actions]
python =
    3.11: ci

[testenv]
skip_install = false
package = editable
poetry_dep_groups = dev
commands =
    python -c "print('Select a specific env e.g. tox -e py311-test')"

[testenv:py311-lint]
description = Ruff lint backend
setenv =
    PYTHONPATH = {toxinidir}/backend
commands =
    ruff check --config backend/pyproject.toml backend/app backend/tests

[testenv:py311-format]
description = Enforce Ruff formatter
setenv =
    PYTHONPATH = {toxinidir}/backend
commands =
    ruff format --config backend/pyproject.toml --check backend

[testenv:py311-type]
description = Type checking with mypy
setenv =
    PYTHONPATH = {toxinidir}/backend
commands =
    mypy --config-file backend/pyproject.toml backend/app backend/tests

[testenv:py311-test]
description = Run backend tests
setenv =
    PYTHONPATH = {toxinidir}/backend
commands =
    pytest backend/tests

[testenv:py311-build]
description = Build backend distribution
commands =
    python -m build backend

[testenv:security]
description = Run Python security scanning
commands =
    pip-audit -r backend/requirements.txt
allowlist_externals =
    sh
    cat

[testenv:py311-all]
description = Run all backend quality gates
skip_install = true
depends =
    py311-lint
    py311-type
    py311-test
    py311-format
    py311-build
    security
commands =
    python -c "print('py311 pipeline successful')"

[testenv:node20-all]
description = Run all frontend quality gates
skip_install = true
depends =
    node20-lint
    node20-type
    node20-test
    node20-build
commands =
    python -c "print('node20 pipeline successful')"

[testenv:ci]
description = Run full project checks
skip_install = true
depends =
    py311-all
    node20-all
commands =
    python -c "print('All checks passed')"

[testenv:node20-base]
description = Install frontend dependencies
skip_install = true
commands =
    corepack enable
    pnpm install --frozen-lockfile
change_dir = frontend
allowlist_externals =
    corepack
    pnpm

[testenv:node20-lint]
description = Lint frontend sources
skip_install = true
depends = node20-base
commands =
    pnpm run lint
change_dir = frontend
allowlist_externals =
    corepack
    pnpm

[testenv:node20-type]
description = Type check frontend
skip_install = true
depends = node20-base
commands =
    pnpm run typecheck
change_dir = frontend
allowlist_externals =
    corepack
    pnpm

[testenv:node20-test]
description = Run frontend unit tests
skip_install = true
depends = node20-base
commands =
    pnpm test
change_dir = frontend
allowlist_externals =
    corepack
    pnpm

[testenv:node20-build]
description = Build frontend assets
skip_install = true
depends = node20-base
commands =
    pnpm run build
change_dir = frontend
allowlist_externals =
    corepack
    pnpm

